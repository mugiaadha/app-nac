<div class="quiz-container">
  <!-- Loading State -->
  <div class="text-center py-5" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading quiz...</p>
  </div>

  <!-- Error State -->
  <div class="text-center py-5" *ngIf="error && !isLoading">
    <i
      class="bi bi-exclamation-triangle text-warning"
      style="font-size: 4rem"
    ></i>
    <h4 class="mt-3 text-muted">{{ error }}</h4>
    <button class="btn btn-primary mt-3" (click)="goBack()">
      <i class="bi bi-arrow-left me-2"></i>Go Back
    </button>
  </div>

  <!-- Quiz Interface -->
  <div *ngIf="currentLesson && !isLoading" class="quiz-interface">
    <!-- Header -->
    <div class="quiz-header">
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-md-4">
            <button class="btn btn-outline-secondary" (click)="goBack()">
              <i class="bi bi-arrow-left me-2"></i>Back
            </button>
          </div>
          <div class="col-md-4 text-center">
            <h5 class="mb-0">{{ currentLesson.title }}</h5>
            <small class="text-muted">{{ course?.title }}</small>
          </div>
          <div class="col-md-4 text-end">
            <div class="timer" *ngIf="quizStarted && !quizCompleted">
              <i class="bi bi-clock me-1"></i>
              <span [ngClass]="getTimeColor()">{{ getTimeFormatted() }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Content -->
    <div class="quiz-content">
      <div class="container">
        <!-- Quiz Start Screen -->
        <div class="quiz-start text-center" *ngIf="!quizStarted && !quizCompleted">
          <div class="quiz-intro">
            <i
              class="bi bi-clipboard-check text-primary"
              style="font-size: 5rem"
            ></i>
            <h2 class="mt-4 mb-3">Ready to Take the Quiz?</h2>
            <p class="lead text-muted mb-4">
              Test your knowledge and see how well you've understood the material.
            </p>
            
            <div class="quiz-info-grid">
              <div class="row justify-content-center">
                <div class="col-md-8">
                  <div class="row text-center">
                    <div class="col-4">
                      <div class="info-card">
                        <div class="h3 text-primary mb-1">{{ currentLesson.questions?.length }}</div>
                        <small class="text-muted">Questions</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="info-card">
                        <div class="h3 text-success mb-1">{{ currentLesson.duration }}</div>
                        <small class="text-muted">Time Limit</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="info-card">
                        <div class="h3 text-warning mb-1">70%</div>
                        <small class="text-muted">Pass Score</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="quiz-instructions mt-4 mb-5">
              <div class="row justify-content-center">
                <div class="col-md-6">
                  <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle me-2"></i>Instructions:</h6>
                    <ul class="list-unstyled mb-0">
                      <li>• Read each question carefully</li>
                      <li>• You can navigate between questions</li>
                      <li>• Timer will start when you begin</li>
                      <li>• You need 70% to pass</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <button class="btn btn-primary btn-lg px-5" (click)="startQuiz()">
              <i class="bi bi-play-circle me-2"></i>Start Quiz
            </button>
          </div>
        </div>

        <!-- Quiz Questions -->
        <div class="quiz-questions" *ngIf="quizStarted && !quizCompleted && getCurrentQuestion() as question">
          <!-- Progress Bar -->
          <div class="quiz-progress mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-medium">
                Question {{ currentQuestionIndex + 1 }} of {{ currentLesson.questions?.length }}
              </span>
              <span class="text-muted">{{ getQuizProgress() }}% Complete</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div 
                class="progress-bar bg-primary" 
                [style.width.%]="getQuizProgress()"
              ></div>
            </div>
          </div>

          <!-- Question Card -->
          <div class="question-card">
            <div class="question-header">
              <h4 class="question-text">{{ question.question }}</h4>
            </div>
            
            <!-- Multiple Choice Options -->
            <div class="options" *ngIf="question.type === 'multiple-choice'">
              <div 
                class="option-item"
                *ngFor="let option of question.options; let i = index"
                [class.selected]="question.userAnswer === i"
                [class.correct]="showExplanation && i === question.correctAnswer"
                [class.incorrect]="showExplanation && question.userAnswer === i && i !== question.correctAnswer"
                (click)="!showExplanation && selectAnswer(currentQuestionIndex, i)"
              >
                <div class="option-content">
                  <div class="option-indicator">
                    <div class="option-circle">
                      <span class="option-letter">{{ String.fromCharCode(65 + i) }}</span>
                    </div>
                  </div>
                  <div class="option-text">{{ option }}</div>
                </div>
              </div>
            </div>

            <!-- True/False Options -->
            <div class="options" *ngIf="question.type === 'true-false'">
              <div 
                class="option-item"
                *ngFor="let option of question.options; let i = index"
                [class.selected]="question.userAnswer === i"
                [class.correct]="showExplanation && i === question.correctAnswer"
                [class.incorrect]="showExplanation && question.userAnswer === i && i !== question.correctAnswer"
                (click)="!showExplanation && selectAnswer(currentQuestionIndex, i)"
              >
                <div class="option-content justify-content-center">
                  <i 
                    class="me-3" 
                    [class.bi-check-circle-fill]="i === 0"
                    [class.bi-x-circle-fill]="i === 1"
                    [class.text-success]="i === 0"
                    [class.text-danger]="i === 1"
                    style="font-size: 1.5rem"
                  ></i>
                  <span class="fw-medium">{{ option }}</span>
                </div>
              </div>
            </div>

            <!-- Explanation -->
            <div class="explanation" *ngIf="showExplanation">
              <div class="explanation-content">
                <div class="d-flex align-items-start">
                  <i class="bi bi-lightbulb text-info me-3" style="font-size: 1.2rem"></i>
                  <div>
                    <h6 class="text-info mb-2">Explanation</h6>
                    <p class="mb-0">{{ question.explanation }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation -->
          <div class="quiz-navigation">
            <div class="d-flex justify-content-between align-items-center">
              <button 
                class="btn btn-outline-secondary"
                [disabled]="currentQuestionIndex === 0"
                (click)="previousQuestion()"
              >
                <i class="bi bi-chevron-left me-2"></i>Previous
              </button>

              <div class="quiz-actions">
                <button 
                  class="btn btn-outline-info me-3"
                  *ngIf="question.userAnswer !== undefined && !showExplanation"
                  (click)="toggleExplanation()"
                >
                  <i class="bi bi-lightbulb me-2"></i>Show Explanation
                </button>
                <button 
                  class="btn btn-outline-info me-3"
                  *ngIf="showExplanation"
                  (click)="toggleExplanation()"
                >
                  <i class="bi bi-eye-slash me-2"></i>Hide Explanation
                </button>
              </div>

              <button 
                class="btn btn-primary"
                [disabled]="question.userAnswer === undefined"
                (click)="nextQuestion()"
              >
                <span *ngIf="currentQuestionIndex < (currentLesson.questions?.length || 0) - 1">
                  Next<i class="bi bi-chevron-right ms-2"></i>
                </span>
                <span *ngIf="currentQuestionIndex === (currentLesson.questions?.length || 0) - 1">
                  Finish Quiz<i class="bi bi-check-circle ms-2"></i>
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- Quiz Results -->
        <div class="quiz-results text-center" *ngIf="quizCompleted">
          <div class="results-card">
            <div class="results-icon">
              <i 
                style="font-size: 5rem"
                [class.bi-trophy-fill]="getScorePercentage() >= 70"
                [class.bi-emoji-frown-fill]="getScorePercentage() < 70"
                [class.text-success]="getScorePercentage() >= 70"
                [class.text-warning]="getScorePercentage() < 70"
              ></i>
            </div>
            
            <h2 class="mt-4 mb-3">Quiz Completed!</h2>
            
            <div class="score-summary">
              <div class="row justify-content-center">
                <div class="col-md-6">
                  <div class="row text-center">
                    <div class="col-4">
                      <div class="score-item">
                        <div class="h2 mb-1" [ngClass]="getScoreColor()">{{ quizScore }}</div>
                        <small class="text-muted">Correct</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="score-item">
                        <div class="h2 mb-1">{{ currentLesson.questions?.length || 0 }}</div>
                        <small class="text-muted">Total</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="score-item">
                        <div class="h2 mb-1" [ngClass]="getScoreColor()">{{ getScorePercentage() }}%</div>
                        <small class="text-muted">Score</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="result-message mt-4 mb-4">
              <div class="alert" [class.alert-success]="getScorePercentage() >= 70" [class.alert-warning]="getScorePercentage() < 70">
                <p class="mb-0" *ngIf="getScorePercentage() >= 70">
                  <i class="bi bi-check-circle me-2"></i>
                  <strong>Congratulations!</strong> You passed the quiz with {{ getScorePercentage() }}%.
                </p>
                <p class="mb-0" *ngIf="getScorePercentage() < 70">
                  <i class="bi bi-x-circle me-2"></i>
                  <strong>Not quite there.</strong> You need 70% to pass. You scored {{ getScorePercentage() }}%.
                </p>
              </div>
            </div>

            <div class="results-actions">
              <button class="btn btn-outline-primary me-3" (click)="retakeQuiz()">
                <i class="bi bi-arrow-clockwise me-2"></i>Retake Quiz
              </button>
              <button 
                class="btn btn-success"
                *ngIf="getScorePercentage() >= 70"
                (click)="continueToNextLesson()"
              >
                Continue Learning<i class="bi bi-chevron-right ms-2"></i>
              </button>
              <button 
                class="btn btn-secondary"
                *ngIf="getScorePercentage() < 70"
                (click)="goToCourse()"
              >
                Review Material<i class="bi bi-book ms-2"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
